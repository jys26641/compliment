<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”°ëœ»í•œ ì¹­ì°¬ í¸ì§€í•¨</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts (Jua for cute headings, Noto Sans KR for body) -->
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        /* Custom Styles for Aesthetics and Responsiveness */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f9ff; /* Very light blue background */
            min-height: 100vh;
        }
        h1, h2, h3, .kids-font {
            font-family: 'Jua', sans-serif; /* Cute, bold font for headings */
        }
        
        /* Utility for 3D button effect */
        .shadow-3d-pink {
            box-shadow: 0 4px 0 0 #f472b6; /* Tailwind pink-400 */
            transition: all 0.1s ease;
        }
        .shadow-3d-pink:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #f472b6;
        }

        .shadow-3d-green {
            box-shadow: 0 4px 0 0 #4ade80; /* Tailwind green-400 */
            transition: all 0.1s ease;
        }
        .shadow-3d-green:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #4ade80;
        }

        /* Custom scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a5b4fc; /* Light blue/purple for scrollbar */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e0f2fe; /* Very light blue */
        }
    </style>
</head>
<body>
    
    <!-- 1. Firebase SDK Imports and Global Exposure (MUST RUN FIRST) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for the Babel script
        window.FirebaseServices = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            addDoc,
            onSnapshot,
            collection,
            query,
            serverTimestamp,
            setLogLevel,
        };
    </script>
    
    <div id="root"></div>

    <!-- 2. React Application (MUST RUN AFTER FirebaseServices is defined) -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Configuration & Constants ---
        // Note: Replace with actual config in a real environment. Using default fallback.
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-compliment-app'; 
        const FIREBASE_CONFIG_PLACEHOLDER = { apiKey: "PLACEHOLDER", projectId: "default-project" };
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' 
                                ? JSON.parse(__firebase_config) 
                                : FIREBASE_CONFIG_PLACEHOLDER;
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Utility Components ---

        // Custom Modal for user feedback
        const CustomModal = ({ message, onClose, title = "ì•Œë¦¼" }) => (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 p-4">
                <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full border-4 border-indigo-400">
                    <div className="text-3xl text-center mb-4 text-indigo-600 kids-font">
                        <i className="ph-fill ph-check-circle text-4xl mr-2"></i> {title}
                    </div>
                    <p className="text-lg text-gray-700 text-center mb-6 leading-relaxed">{message}</p>
                    <button 
                        onClick={onClose}
                        className="w-full bg-indigo-500 text-white kids-font text-xl py-2 rounded-xl shadow-3d-green"
                    >
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        );

        // Individual Compliment Card
        const ComplimentCard = ({ compliment }) => {
            // Format timestamp from Firestore or use default if pending
            const date = compliment.createdAt 
                ? new Date(compliment.createdAt.toDate()).toLocaleDateString('ko-KR', {
                    month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }) 
                : 'ë°©ê¸ˆ ì „';

            // Styling based on recipient
            const isEveryone = compliment.recipient && compliment.recipient.trim().toLowerCase() === 'ëª¨ë‘';
            const cardClass = isEveryone ? 'bg-yellow-50 border-yellow-300' : 'bg-pink-50 border-pink-300';
            const recipientTextClass = isEveryone ? 'text-yellow-700' : 'text-pink-600';

            return (
                <div className={`p-4 rounded-xl shadow-lg hover:shadow-xl transition-shadow ${cardClass} border-b-4`}>
                    <div className="flex justify-between items-center mb-3 border-b pb-2 border-dashed border-gray-300">
                        <div className="text-sm font-bold text-gray-700 flex items-center">
                            <i className="ph-fill ph-star text-base mr-1 text-yellow-500"></i>
                            ë°›ëŠ” ì‚¬ëŒ: <span className={`${recipientTextClass} kids-font text-xl ml-1`}>{compliment.recipient}</span>
                        </div>
                        <div className="text-xs text-gray-500">{date}</div>
                    </div>
                    {/* Message content */}
                    <p className="text-base text-gray-800 break-words my-3 min-h-[40px] leading-relaxed whitespace-pre-wrap">
                        {compliment.message}
                    </p>
                    {/* Sender info */}
                    <div className="mt-3 pt-2 border-t border-dashed border-gray-300 text-right text-xs text-gray-600">
                        <i className="ph-fill ph-paper-plane-tilt"></i> ë³´ë‚¸ ì‚¬ëŒ: <span className="font-semibold">{compliment.sender}</span>
                    </div>
                </div>
            );
        };
        
        // Compliment Submission Form
        const ComplimentForm = ({ userId, firebaseDb, onSubmitted }) => { 
            const [sender, setSender] = useState('');
            const [recipient, setRecipient] = useState('');
            const [message, setMessage] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [modalMessage, setModalMessage] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const trimmedSender = sender.trim();
                const trimmedRecipient = recipient.trim();
                const trimmedMessage = message.trim();

                if (!trimmedSender || !trimmedRecipient || !trimmedMessage) {
                    setModalMessage({ title: "ì…ë ¥ ì˜¤ë¥˜", message: "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì•¼ í¸ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”!" });
                    return;
                }
                
                if (!firebaseDb || !userId) {
                    console.error("Write attempt failed: DB or UserId not available.");
                    setModalMessage({ title: "ì˜¤ë¥˜", message: "ì‹œìŠ¤í…œ ì—°ê²° ì˜¤ë¥˜: ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”." });
                    return;
                }

                setIsSubmitting(true);
                
                try {
                    const complimentData = {
                        sender: trimmedSender,
                        recipient: trimmedRecipient,
                        message: trimmedMessage,
                        createdAt: FirebaseServices.serverTimestamp(),
                        userId: userId, // Author's ID
                    };

                    // Public collection path for shared access
                    const publicCollectionPath = `/artifacts/${APP_ID}/public/data/compliments`;
                    
                    await FirebaseServices.addDoc(
                        FirebaseServices.collection(firebaseDb, publicCollectionPath), 
                        complimentData
                    );
                    
                    setModalMessage({ title: "í¸ì§€ ì „ì†¡ ì„±ê³µ! ğŸ’Œ", message: "ë”°ëœ»í•œ ì¹­ì°¬ í¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!" });
                    
                    // Clear form
                    setSender('');
                    setRecipient('');
                    setMessage('');
                    
                    if (onSubmitted) onSubmitted();

                } catch (error) {
                    console.error("Error writing document: ", error);
                    setModalMessage({ title: "ì „ì†¡ ì‹¤íŒ¨", message: "í¸ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message });
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <>
                    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-2xl shadow-xl border-4 border-pink-200">
                        <h2 className="kids-font text-3xl text-pink-600 mb-5 text-center border-b pb-3">
                            <i className="ph-fill ph-pencil-line text-2xl mr-2"></i> ìƒˆ ì¹­ì°¬ í¸ì§€ ì“°ê¸°
                        </h2>
                        <div className="space-y-4">
                            <div className="flex flex-col">
                                <label htmlFor="sender" className="kids-font text-gray-700 mb-1">ë³´ë‚¸ ì‚¬ëŒ (ë‚´ ì´ë¦„)</label>
                                <input
                                    id="sender"
                                    type="text"
                                    value={sender}
                                    onChange={(e) => setSender(e.target.value)}
                                    className="p-3 border-2 border-pink-300 rounded-xl focus:ring-pink-400 focus:border-pink-400 transition"
                                    placeholder="ì˜ˆ: ì œë¯¸ë‚˜ì´"
                                    required
                                />
                            </div>
                            <div className="flex flex-col">
                                <label htmlFor="recipient" className="kids-font text-gray-700 mb-1">ë°›ëŠ” ì‚¬ëŒ (ë™ë£Œ ì´ë¦„)</label>
                                <input
                                    id="recipient"
                                    type="text"
                                    value={recipient}
                                    onChange={(e) => setRecipient(e.target.value)}
                                    className="p-3 border-2 border-indigo-300 rounded-xl focus:ring-indigo-400 focus:border-indigo-400 transition"
                                    placeholder="ì˜ˆ: ì² ìˆ˜, ì˜í¬, ë˜ëŠ” ëª¨ë‘"
                                    required
                                />
                            </div>
                            <div className="flex flex-col">
                                <label htmlFor="message" className="kids-font text-gray-700 mb-1">ì¹­ì°¬ ë©”ì‹œì§€</label>
                                <textarea
                                    id="message"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    className="p-3 border-2 border-yellow-300 rounded-xl focus:ring-yellow-400 focus:border-yellow-400 transition h-32 resize-none"
                                    placeholder="ë¬´ìŠ¨ ì¼ì„ ì˜ í–ˆëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•´ ì£¼ì„¸ìš”!"
                                    required
                                ></textarea>
                            </div>
                        </div>
                        
                        <button 
                            type="submit"
                            disabled={isSubmitting}
                            className={`w-full mt-6 py-3 rounded-xl text-white kids-font text-xl shadow-3d-green ${isSubmitting ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'}`}
                        >
                            {isSubmitting ? 'ì „ì†¡ ì¤‘...' : <><i className="ph-fill ph-heart-straight text-lg mr-2"></i> ì‚¬ë‘ ë‹´ì•„ ë³´ë‚´ê¸°</>}
                        </button>
                    </form>
                    
                    {modalMessage && <CustomModal title={modalMessage.title} message={modalMessage.message} onClose={() => setModalMessage(null)} />}
                </>
            );
        };
        
        // --- Main App Component ---
        const App = () => {
            const [compliments, setCompliments] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [error, setError] = useState(null);
            
            // State for Firebase instances
            const [firebaseDb, setFirebaseDb] = useState(null);
            const [firebaseAuth, setFirebaseAuth] = useState(null);
            
            const messagesEndRef = useRef(null);
            const scrollContainerRef = useRef(null);

            // Scroll to bottom when new message arrives or on initial load
            const scrollToBottom = () => {
                const container = scrollContainerRef.current;
                if (container) {
                    // Smooth scroll to the bottom of the container
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                }
            };

            // 1. Initialize Firebase and Authenticate
            useEffect(() => {
                if (!window.FirebaseServices) {
                    setError("Firebase SDK ë¡œë“œ ì‹¤íŒ¨.");
                    setIsLoading(false);
                    setIsAuthReady(true);
                    return;
                }

                if (FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey !== "PLACEHOLDER") {
                    try {
                        const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, setLogLevel } = window.FirebaseServices;

                        setLogLevel('debug'); 
                        const app = initializeApp(FIREBASE_CONFIG); 
                        
                        const newAuth = getAuth(app);
                        const newDb = getFirestore(app);
                        setFirebaseAuth(newAuth);
                        setFirebaseDb(newDb);

                        let authAttempted = false;

                        // Check initial token and attempt sign-in
                        (async () => {
                            try {
                                if (INITIAL_AUTH_TOKEN) {
                                    await signInWithCustomToken(newAuth, INITIAL_AUTH_TOKEN);
                                    authAttempted = true;
                                }
                            } catch (e) {
                                console.warn("Custom token sign-in failed, checking anonymous status.", e);
                            }
                        })();
                        
                        // Auth Listener
                        const unsubscribe = onAuthStateChanged(newAuth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else if (!authAttempted) {
                                // If not signed in by token, try anonymous sign-in
                                authAttempted = true;
                                signInAnonymously(newAuth)
                                    .then(anonUser => setUserId(anonUser.user.uid))
                                    .catch(anonError => {
                                        console.error("Anonymous sign-in failed:", anonError);
                                        setError("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨: " + anonError.message);
                                    });
                            } 
                            // Set ready state regardless of success to unblock Firestore listeners
                            setIsAuthReady(true);
                            setIsLoading(false);
                        });

                        return () => unsubscribe(); // Cleanup auth listener

                    } catch (e) {
                        console.error("Firebase Initialization Error:", e);
                        setError("Firebase ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                        setIsLoading(false);
                        setIsAuthReady(true);
                    }
                } else {
                    // Fallback for missing config
                    setIsAuthReady(true);
                    setIsLoading(false);
                    setUserId(crypto.randomUUID());
                    setError("âš ï¸ Firebase í™˜ê²½ ì„¤ì •ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. ë°ì´í„° ì €ì¥ ê¸°ëŠ¥ì€ ë°ëª¨ë¡œ ì‘ë™í•©ë‹ˆë‹¤.");
                }
            }, []); // Run only once on mount


            // 2. Data Listener (runs when auth is ready and DB is initialized)
            useEffect(() => {
                if (!isAuthReady || !firebaseDb || !userId) {
                    console.log("Waiting for Auth/DB readiness to start listener...");
                    return;
                }
                
                // Path: /artifacts/{appId}/public/data/compliments
                const publicCollectionPath = `/artifacts/${APP_ID}/public/data/compliments`;
                const complimentsCol = window.FirebaseServices.collection(firebaseDb, publicCollectionPath);
                
                const unsubscribe = window.FirebaseServices.onSnapshot(
                    window.FirebaseServices.query(complimentsCol), 
                    (snapshot) => {
                        const loadedCompliments = snapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                            
                        setCompliments(prevCompliments => {
                            const newCount = loadedCompliments.length;
                            // Only scroll if a new message was added and not on initial load
                            if (newCount > prevCompliments.length && prevCompliments.length > 0) {
                                // Delay scroll slightly to allow DOM update
                                setTimeout(scrollToBottom, 50); 
                            } else if (newCount > 0 && prevCompliments.length === 0) {
                                // Scroll on first load with data
                                setTimeout(scrollToBottom, 100); 
                            }
                            return loadedCompliments;
                        });
                    }, 
                    (error) => {
                        console.error("Firestore Snapshot Error:", error);
                        setError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
                    }
                );

                return () => unsubscribe(); // Cleanup listener

            }, [isAuthReady, userId, APP_ID, firebaseDb]); // Dependencies

            // Initial Scroll to bottom on first data load
            useEffect(() => {
                if (!isLoading && compliments.length > 0) {
                    // Scroll to bottom immediately on first full render
                    scrollToBottom();
                }
            }, [isLoading, compliments.length]); // Dependencies

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-f0f9ff">
                        <div className="text-3xl text-indigo-500 kids-font animate-pulse flex items-center">
                            <i className="ph-fill ph-envelop text-4xl mr-3"></i> í¸ì§€í•¨ì„ ì—´ê³  ìˆì–´ìš”...
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-xl mx-auto p-4 md:p-6 flex flex-col min-h-screen">
                    {/* Header */}
                    <header className="text-center mb-6 pt-4">
                        <h1 className="kids-font text-5xl text-indigo-600 border-b-4 border-indigo-400 inline-block pb-2 px-4 shadow-md bg-white rounded-t-xl">
                            <i className="ph-fill ph-heart-straight text-red-500 mr-2"></i> ë”°ëœ»í•œ ì¹­ì°¬ í¸ì§€í•¨
                        </h1>
                        <p className="text-xs text-gray-500 mt-2">
                            ì„œë¡œì—ê²Œ í˜ì´ ë˜ëŠ” ë©”ì‹œì§€ë¥¼ ë‚˜ëˆ ì£¼ì„¸ìš”. (ì‚¬ìš©ì ID: <span className="font-mono text-xs text-indigo-500 break-all">{userId}</span>)
                        </p>
                        {error && (
                            <div className="mt-2 p-3 bg-red-100 text-red-700 rounded-xl text-sm border-2 border-red-400 font-semibold">
                                <i className="ph-fill ph-warning-octagon mr-1"></i> ì˜¤ë¥˜ ë°œìƒ: {error}
                            </div>
                        )}
                    </header>
                    
                    {/* Compliment List (Scrollable Area) */}
                    <div ref={scrollContainerRef} 
                         className="flex-1 overflow-y-auto custom-scrollbar p-4 bg-white rounded-xl shadow-inner mb-6 border-4 border-indigo-200" 
                         style={{ minHeight: '350px', maxHeight: '50vh' }}
                    >
                        <div className="grid grid-cols-1 gap-4">
                            {compliments.length > 0 ? (
                                compliments.map((c) => (
                                    <ComplimentCard key={c.id} compliment={c} />
                                ))
                            ) : (
                                <div className="text-center p-10 text-gray-500 kids-font">
                                    <i className="ph ph-envelope-open text-5xl mb-3 block"></i>
                                    <p className="text-xl">ì•„ì§ ë°›ì€ í¸ì§€ê°€ ì—†ì–´ìš”.</p>
                                    <p className="text-lg mt-1">ì²« ë²ˆì§¸ ì¹­ì°¬ì„ ë³´ë‚´ì£¼ì„¸ìš”!</p>
                                </div>
                            )}
                            {/* Scroll marker */}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    {/* Compliment Form */}
                    <ComplimentForm 
                        userId={userId} 
                        firebaseDb={firebaseDb} 
                        onSubmitted={scrollToBottom} 
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
